# KRX data reader

# 개요
한국거래소 데이터를 불러와 적절한 전처리 후 mysql db에 자동 저장하는 과정까지
구현한 학습용 코드입니다. 개인적인 용도로 만든 코드라 기능이 불안정하지만 비슷한 기능의 코드를 구현하고자하는 분들께 도움이 되었으면 좋겠습니다.

* api 서브패키지는 아래 예시 코드와 같이 바로 이용할 수 있습니다.
* db 서브패키지는 mysql 설치 및 관련 초기 설정을 진행하여야 이용할 수 있습니다.
* api를 이용하는 경우 krx홈페이지 특성 상 2년이상 기간의 데이터를 한번에 호출할 수 없습니다.
* db를 이용하여 데이터를 db에 저장하는경우 2년 이상 데이터를 한번에 저장할 수 있습니다. 
* 짧은 시간에 다량의 API 호출시 한국거래소 홈페이지로부터 일정 시간동안 IP가 차단될 수 있으니 무분별한 반복문 사용은 유의 바랍니다.

# 주요기능
### api.index
```python
from krxdata_pub.api import index

# 지수 code 관련 데이터
df = index.get_index_code()

'''
  full_code short_code  index_name  market_code market_name
0         5        300     KRX300         KRX         KRX
1         5        600     KTOP30         KRX         KRX
2         5        042     KRX100         KRX         KRX
3         5        043     KRX자동차         KRX         KRX
4         5        044     KRX반도체         KRX         KRX
'''

# 지수 ohlcv 관련 데이터 반환 
df = index.get_index_ohlcv("코스피200", "20210101", "20230101")

''' 
      일자      종가     시가    고가    저가       거래량       거래대금  \
0 2022-12-29  291.10  294.98  295.94  291.10  114466989  4641526284560   
1 2022-12-28  297.09  299.36  299.36  296.59  137294971  5455738601610   
2 2022-12-27  304.22  303.77  305.02  302.83  122967923  4996334393543   
3 2022-12-26  302.27  301.76  302.97  300.66   78881090  3328680326460   
4 2022-12-23  302.07  303.14  304.42  301.47   94834788  3983860533166   
       상장시가총액     index_name  
0  1541773570334525     코스피200  
1  1572078453740100     코스피200  
2  1610156557132930     코스피200  
3  1600153844130730     코스피200  
4  1597263274400675     코스피200 
'''

# 지수 기본 정보 데이터
df = index.get_index_info()

'''
    지수명     영문지수명      기준일        발표일    기준지수 산출주기  \
0  KRX300      KRX300    2010-01-04   2018-02-05  1000.00   1초   
1  KTOP30      KTOP30    1996-01-03   2015-07-13   888.85   2초   
2  KRX100      KRX100    2001-01-02   2005-06-01  1000.00   1초   
3  KRX자동차    KRXAutos  2006-01-02   2006-01-23  1000.00   2초   
4  KRX반도체  KRXSemicon  2006-01-02   2006-01-23  1000.00   2초   
          산출시간       구성종목수 index_class  
0  09:00:30 ~ 15:30:00    302         KRX  
1  09:00:30 ~ 15:30:00     30         KRX  
2  09:00:30 ~ 15:30:00    102         KRX  
3  09:00:30 ~ 15:30:00     16         KRX  
4  09:00:30 ~ 15:30:00     41         KRX
'''

# 지수 조회 일자 기준 구성 종목 데이터
df = index.get_index_components("코스닥150","20230623")

'''
  종목코드       종목명        종가       상장시가총액      조회일     지수명
0  247540    에코프로비엠     263000   25721753472000   20230623  코스닥150
1  086520      에코프로      758000   20183772344000   20230623  코스닥150
2  091990  셀트리온헬스케어   69500    11429963745000   20230623  코스닥150
3  066970      엘앤에프     253500    9186783216000    20230623  코스닥150
4  035900      JYP Ent.    131300    4660820699600    20230623  코스닥150
'''

# 지수 PER 일자별 데이터
df = index.get_index_PER("코스피", "20210101", "20230101")

'''
     일자       종가    PER    선행PER  지수명
0 2022-12-29  2236.40  10.76    NaN  코스피
1 2022-12-28  2280.45  10.97    NaN  코스피
2 2022-12-27  2332.79  11.22    NaN  코스피
3 2022-12-26  2317.14  11.14    NaN  코스피
4 2022-12-23  2313.69  11.13    NaN  코스피
'''

# 지수 PBR 일자별 데이터
df = index.get_index_PBR("코스피", "20210101", "20230101")

'''
     일자      종가     PBR     지수명
0 2023-04-28  326.46  0.91  코스피200
1 2023-04-27  325.09  0.90  코스피200
2 2023-04-26  323.97  0.90  코스피200
3 2023-04-25  324.48  0.90  코스피200
4 2023-04-24  328.70  0.91  코스피200

'''

# 지수 배당수익률 일자별 데이터
df = index.get_index_div_rate("코스피", "20210101", "20230101")

'''
     일자       종가  배당수익률  지수명
0 2022-12-29  2236.40   2.22  코스피
1 2022-12-28  2280.45   2.17  코스피
2 2022-12-27  2332.79   2.12  코스피
3 2022-12-26  2317.14   2.14  코스피
4 2022-12-23  2313.69   2.14  코스피
'''
```

### api.stock
```python
from krxdata_pub.api import stock

# 주식 종목코드 관련 데이터
df=stock.get_stock_code()

'''
     full_code   short_code stock_name    market_code  market_name  market_eng_name
0  KR7060310000     060310         3S         KSQ          코스닥          KOSDAQ
1  KR7095570008     095570     AJ네트웍스      STK         유가증권          KOSPI
2  KR7006840003     006840      AK홀딩스       STK         유가증권          KOSPI
3  KR7054620000     054620        APS         KSQ          코스닥          KOSDAQ
4  KR7265520007     265520      AP시스템       KSQ          코스닥          KOSDAQ

'''

# 주식 ohlcv 데이터
df=stock.get_stock_ohlcv("삼성전자", "20210101", "20230101")

'''
      일자     종가     시가    고가   저가    거래량      거래대금  \
0 2022-12-29  55300  56000  56200  55300  11295935  628653753150   
1 2022-12-28  56600  57600  57600  56400  14665410  832919426100   
2 2022-12-27  58100  58000  58400  57900  10667027  620410096800   
3 2022-12-26  57900  58000  58100  57700   6756411  391223170600   
4 2022-12-23  58100  58200  58400  57700   9829407  570401785680   
       시가총액       상장주식수     stock_name  
0  330128975015000  5969782550       삼성전자  
1  337889692330000  5969782550       삼성전자  
2  346844366155000  5969782550       삼성전자  
3  345650409645000  5969782550       삼성전자  
4  346844366155000  5969782550       삼성전자  

'''

# 주식 기본 정보 데이터
df=stock.get_basic_info()

'''
     표준코드     단축코드       한글종목명        한글종목약명  \
0  KR7098120009  098120  (주)마이크로컨텍솔루션   마이크로컨텍솔   
1  KR7009520008  009520      (주)포스코엠텍       포스코엠텍   
2  KR7095570008  095570     AJ네트웍스보통주      AJ네트웍스   
3  KR7006840003  006840      AK홀딩스보통주       AK홀딩스   
4  KR7282330000  282330     BGF리테일보통주       BGF리테일   
                  영문종목명          상장일    시장구분  증권구분    소속부    주식종류    액면가  \
0  Micro Contact Solution Co.Ltd. 2008-09-23  KOSDAQ   주권      중견기업부   보통주   500.0   
1            POSCO M-TECH CO.LTD. 1997-11-10  KOSDAQ   주권      우량기업부   보통주   500.0   
2             AJ Networks Co.Ltd. 2015-08-21   KOSPI   주권                 보통주   1000.0   
3                AK Holdings Inc. 1999-08-11   KOSPI   주권                 보통주   5000.0   
4                      BGF Retail 2017-12-08   KOSPI   주권                 보통주   1000.0   
    상장주식수  
0   8312766  
1  41642703  
2  46822295  
3  13247561  
4  17283906  
'''

# 주식시장 투자자별 순매매 추이 데이터
df=stock.get_investor_trading_trend_market("20230101","20230501","KOSPI")

'''
     일자          금융투자       보험          투신         사모        은행  \
0 2023-04-28 -347261655590   4364757088   9575342784  -7121002936  1700140348   
1 2023-04-27 -571762522657  10383379440  24805635641  20404049126   800225695   
2 2023-04-26  -61995042805  -4223821283 -47539128616 -56972749688  1180142244   
3 2023-04-25   48669797443   7301969567 -83562128478   2378413928  3594720456   
4 2023-04-24  248757171431  -5239649360 -76726733066 -24770105125  3295240573   
     기타금융      연기금등      기타법인       개인           외국인  \
0  3712101649 -20026036599 -81408925834  136008158591  297814133693   
1 -2133605265  32395984842  15680381473  186820560800  280050131380   
2  -749519690  15337684269  24484305757  221876593242  -92523705480   
3 -2687154030  24363084183  -6425504034   -2256127154    8604656152   
4 -2208592285 -38771401129  15232597474  -82804898268  -33457709260   
     기타외국인 market  
0  2642986806  KOSPI  
1  2555779525  KOSPI  
2  1125242050  KOSPI  
3    18271967  KOSPI  
4 -3305920985  KOSPI  
'''

# 개별주식 투자자별 순매매 추이 데이터
df=stock.get_investor_trading_trend_stock("삼성전자","20230101","20230501")

'''          
        일자      금융투자        보험         투신         사모          은행  \
0 2023-04-28 -128668764900  5304216500  33601371300  29725225800   -12152700   
1 2023-04-27 -157553010500   281308700   3494862600   9202708900   -92898700   
2 2023-04-26  -22392511500   -41451300 -10564950500  -2816190000   591830900   
3 2023-04-25   32581659200  1527052400 -25247330800 -24351954300  1367393600   
4 2023-04-24   75197508300 -1201146800 -25563637900    135491400   202046800   
    기타금융      연기금등     기타법인        개인         외국인      기타외국인  \
0  272014800 -19019068500 -5250522200 -174022135200  258267338300 -197523200   
1   20588200 -13050929900 -2485786700  -90007335700  250682088900 -491595800   
2   -1947500 -27169183600 -8124471300  -22122442100   92709323900  -68007000   
3 -803650200 -19686494800  -628238600   80737448400  -45775794500  279909600   
4 -557070400 -26057618800 -4040553600 -106378543300   88695198600 -431674300   
  stock_name  
0       삼성전자  
1       삼성전자  
2       삼성전자  
3       삼성전자  
4       삼성전자  '''

# 상장기업 상세 정보 데이터
df=stock.get_listed_company_details()

'''
  종목코드     종목명    시장구분    소속부     상장특례    업종코드        업종명                 결산월    지정자문인  \
0  060310      3S      KOSDAQ   중견기업부              032602      전자부품 제조업              03         
1  095570  AJ네트웍스    KOSPI                         147603      산업용 기계 및 장비 임대업     12         
2  006840   AK홀딩스     KOSPI                         116409      기타 금융업                  12         
3  054620     APS       KOSDAQ  중견기업부              116409      기타 금융업                 12         
4  265520   AP시스템     KOSDAQ  우량기업부              032902    특수 목적용 기계 제조업         12         
   상장주식수   액면가       자본금   통화구분              대표이사          대표전화  \
0  48536642   500.0  24268321000  원(KRW)               김세완          02-896-9474   
1  46822295  1000.0  46822295000  원(KRW)               손삼달          02-6363-9999   
2  13247561  5000.0  66237805000  원(KRW)  채형석 백차현(각자 대표이사)    02-768-2923   
3  20394221   500.0  10197110500  원(KRW)               정기로          031-776-1800   
4  15281421   500.0   7640710500  원(KRW)               김영주          031-379-2700   
                    주소  
0   서울특별시 금천구 가산디지털1로 75-24 1310호  
1     서울특별시 송파구 정의로8길 9 (문정동AJ빌딩)  
2            서울특별시 마포구 양화로 188 -   
3  경기도 화성시 동탄면 동탄산단9길 23-12 (동탄면)  
4  경기도 화성시  동탄면 동탄산단8길 15-5 &nbsp  
'''

# 개별주식 PER, PBR, 배당 데이터
df=stock.get_stock_PER_PBR_Div("삼성전자","20230101","20230501")

'''
      일자     종가   EPS    PER   FWD_EPS  FWD_PER    BPS   PBR   DPS  \
0 2023-04-28  65500  5777  11.34     2714    24.14  43611  1.50  1444   
1 2023-04-27  64600  5777  11.18     2714    23.80  43611  1.48  1444   
2 2023-04-26  64100  5777  11.10     2714    23.62  43611  1.47  1444   
3 2023-04-25  63600  5777  11.01     2714    23.44  43611  1.46  1444   
4 2023-04-24  65200  5777  11.29     2714    24.03  43611  1.50  1444   
   DVD_YLD stock_name  
0     2.20       삼성전자  
1     2.24       삼성전자  
2     2.25       삼성전자  
3     2.27       삼성전자  
4     2.21       삼성전자  
'''

# 주식시장 외국인 보유 비중 데이터
df=stock.get_foreign_holdings_market("20230101","20230501","KOSPI")

'''          
       일자       시가총액_전체   시가총액_외국인보유    시가총액_외국인비율    주식수_전체  \
0 2023-04-28  1979839469128982  626345436256568       31.64            63501493864   
1 2023-04-27  1974101089770741  622284187842433       31.52            63498649541   
2 2023-04-26  1964553908314712  618907868061225       31.50            63489403942   
3 2023-04-25  1967147727128900  618980212955115       31.47            63481726703   
4 2023-04-24  1996621732458125  627551594386219       31.43            64039544496   
 주식수_외국인보유  주식수_외국인비율   market  
0  11572138624      18.22          KOSPI  
1  11567178403      18.22          KOSPI  
2  11569134166      18.22          KOSPI  
3  11574973324      18.23          KOSPI  
4  11666973333      18.22          KOSPI  
'''


# 개별주식 외국인 보유 비중 데이터
df=stock.get_foreign_holdings_stock("삼성전자","20230101","20230501")

'''
      일자     종가     상장주식수  외국인보유수량  외국인지분율     외국인한도수량  외국인한도소진율  \
0 2023-04-28  65500  5969782550  3092645815     51.80          5969782550     51.80   
1 2023-04-27  64600  5969782550  3088205952     51.73          5969782550     51.73   
2 2023-04-26  64100  5969782550  3085388514     51.68          5969782550     51.68   
3 2023-04-25  63600  5969782550  3086117183     51.70          5969782550     51.70   
4 2023-04-24  65200  5969782550  3083353159     51.65          5969782550     51.65   
  stock_name  
0  삼성전자  
1  삼성전자  
2  삼성전자  
3  삼성전자  
4  삼성전자  
'''


# 주식시장 산업별 분포 데이터
df=stock.get_industry_distribution("20230703","KOSPI")
'''
          업종명      회사수  종목수     상장주식수      시가총액_금액   시가총액_비중  거래량_수량  \
0  농업 임업 및 어업     3      3        25653805     402201190300     0.02         39666   
1          광업         1      1        42373459     215680906310     0.01        150035   
2        음식료품       36     46      1356581343   24309639516982    1.18       12777147   
3        섬유의복       24     25       970710323    8664849532632    0.42       50178719   
4        종이목재       19     20       798927529    3452217629101    0.17        3037987   
   거래량_비중   거래대금_금액  거래대금_비중  
0    0.01        439153230     0.00  
1    0.02        757484650     0.01  
2    2.07     139218381947     1.55  
3    8.12      84625181032     0.94  
4    0.49      42167222604     0.47  

'''

```

### db.index
```python
# 초기설정 방법
# mysql community edition 설치 및 db 생성
# security_market 스키마 생성
# db.secret폴더에 scretes.txt 파일 생성 및 secret_frame.txt와 같이 mysqldb password 입력

from krxdata_pub.db import index

# db 생성시 schema
```
![db_schema](https://github.com/harimha/krxdata_pub/assets/46281167/788237c7-784a-49bf-953e-33acdb137e5a)

```python
# 지수 코드 관련 클래스
icode = index.IndexCode()

# mysql db에 저장
icode.store_data()
```
![index_code](https://github.com/harimha/krxdata_pub/assets/46281167/2dfcab99-fc0d-41ab-9f38-3fb8f8746845)

```python
# db에서 원하는 칼럼만 data 불러오기
df = icode.read_db(["full_code","short_code","index_name"])
df.head()
'''
  full_code short_code index_name
0         1        001        코스피
1         1        002     코스피대형주
2         1        003     코스피중형주
3         1        004     코스피소형주
4         1        005       음식료품
'''
```

```python
# 지수 ohlcv 클래스
iohlcv = index.IndexOHLCV()

# mysql db에 저장 (2년 이상 데이터도 순차적으로 자동 저장)
iohlcv.store_data_period("코스피200", "20180101", "20230705")

'''
>>> iohlcv.store_data_period("코스피200", "20180101", "20230705")
코스피200 is stored 2018-01-01~2019-01-01
코스피200 is stored 2019-01-02~2020-01-01
코스피200 is stored 2020-01-02~2020-12-31
코스피200 is stored 2021-01-01~2021-12-31
코스피200 is stored 2022-01-01~2022-12-31
코스피200 is stored 2023-01-01~2023-07-05
'''
```
![index_ohlcv](https://github.com/harimha/krxdata_pub/assets/46281167/8a937cbe-3007-4f20-aebb-c8c4797b8c4a)


```python
# db에서 원하는 칼럼, 특정 기간 data 불러오기
df = iohlcv.read_db("코스피200", ["일자","종가","상장시가총액"], "20230101", "20230705")
'''
      일자      종가      상장시가총액
0 2023-01-02  289.79  1535786624843340
1 2023-01-03  289.58  1530480035423500
2 2023-01-04  295.98  1557422148946850
3 2023-01-05  297.87  1563535980673890
4 2023-01-06  301.53  1581913625677170
'''

# 지수 기본정보 클래스
iinfo = index.IndexInfo()

# mysql db에 저장
iinfo.store_data()
```
![index_info](https://github.com/harimha/krxdata_pub/assets/46281167/a32397f0-df60-4abc-af65-39db13d8c4a4)

```python
# db에서 원하는 칼럼만 data 불러오기
df = iinfo.read_db(['지수명', '기준일', '발표일','구성종목수'])
'''
>>> df.tail()
         지수명        기준일           발표일      구성종목수
151  통신방송서비스     1996-07-01    1997-01-03     19
152    통신서비스     1996-07-01    1997-01-03      9
153      통신업     2000-01-04    2000-11-06      5
154     통신장비     1996-07-01    1997-01-03     53
155       화학     1980-01-04    1983-01-04    103
'''
```
```python
# 지수 구성종목 클래스
icompo = index.IndexComponents()

# 특정지수, 조회일자 지수 구성종목 정보 db에 저장
icompo.store_data("코스피200", "20230703")
```
![index_components](https://github.com/harimha/krxdata_pub/assets/46281167/1df83d19-a64d-433a-a594-d2943c768c8e)
```python
# db에서 원하는 칼럼만 data 불러오기
df = icompo.read_db(['종목코드', '종목명', '조회일', '지수명'])
df.head()
'''
   종목코드     종목명        조회일     지수명
0  000080   하이트진로      2023-07-03  코스피200
1  000100    유한양행      2023-07-03  코스피200
2  000120  CJ대한통운      2023-07-03  코스피200
3  000150      두산        2023-07-03  코스피200
4  000210      DL         2023-07-03  코스피200
'''
```
```python
# 지수 PER 데이터 조회 
iper = index.IndexPER()

# mysql db에 저장 (2년 이상 데이터도 순차적으로 자동 저장)
iper.store_data_period("코스피200","20210101","20230705")
'''
>>> iper.store_data_period("코스피200","20210101","20230705")
코스피200 is stored 2021-01-01~2022-01-01
코스피200 is stored 2022-01-02~2023-01-01
코스피200 is stored 2023-01-02~2023-07-05
'''
```
![index_per](https://github.com/harimha/krxdata_pub/assets/46281167/c9a5174d-f993-4c45-b1ea-f4c8d0e6bcd6)



```
